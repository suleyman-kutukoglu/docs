---
title: "VPC Projelerde Image Export Etme"
description: " Bu dokümantasyon RNG Technology iç süreçleri için hazırlanmıştır. Amaç, müşteri projelerindeki sanal makinelerin (VM) image export sürecini profesyonel ve standart bir şekilde yönetmektir."
---

## 1. Ön Gereksinimler

- Müşteri hesabında **Enforce MFA** etkinse geçici olarak devre dışı bırakılmalıdır.
- Müşteri hesabında **FullAccess SYMP API** yetkisine sahip, MFA kapalı bir kullanıcı oluşturulmalıdır.

---

## 2. Export Sunucusunun Hazırlanması

Yeni bir sunucu, export edilecek VM'in bulunduğu projede aşağıdaki özelliklerle oluşturulur:

- **Image:** `Fedora Toolbox XXX (Eğer görünmüyorsa Marketplace bölümünden indirilebilir)`
- **Key Pair:** `AccountAdi_ProjeAdi_Export`
- **Instance Type:** `z4.xlarge` (4 vCPU, 16 GB RAM)
- **Boot Disk:** Export edilecek sunucunun boyutunun **2 katı** (Örn: 100 GB VM için 200 GB disk)
- \*\*Network: \*\*Default VPC Network

---

## 3. Sunucuya Bağlantı

Sunucuya SSH ile bağlanıldıktan sonra aşağıdaki adımlar izlenir:

```bash
curl -k https://cloud-adresi.rng.tech
```

Eğer bağlantı başarısız olursa (Opsiyonel adım):

```bash
echo "169.254.64.2 https://cloud-adresi.rng.tech" | sudo tee -a /etc/hosts
curl -k https://cloud-adresi.rng.tech
```

Sonrasında SYMP güncellemesi yapılır:

```bash
symp-update -c https://cloud-adresi.rng.tech
```

---

## 4. Export Script Hazırlığı

1. Root yetkileri alınır ve doğru klasöre geçilir:

   ```bash
   sudo -i
   cd /home/fedora
   ```
2. Aşağıdaki kod bloğu kopyalanır ve İçerik `export.sh` isimli dosyaya kaydedilir.
3. Dosya içerisinde aşağıdaki değişkenler düzenlenir:
   - `SYMP_URL`
   - `SYMP_USERNAME`
   - `SYMP_DOMAIN`
   - `SYMP_PROJECT`
   - `SYMP_PASSWORD`

```bash
#!/bin/bash

set -ex

if [ "$(whoami)" != "root" ]
then
  echo "Not running as root - re-executing with sudo"
  sudo "$0" $1
  exit
fi

IMAGE_ID=$1
### Please configure the below ->
export SYMP_URL=https://cloud-adresi.rng.tech
export SYMP_USERNAME=exampleuser
export SYMP_DOMAIN=exampleaccount
export SYMP_PROJECT="Default Project"
export SYMP_PASSWORD=***

LOG="log_for_last_run"
echo `date` > $LOG
TLOG="tee -a $LOG"

SYMP="symp -k"
TOKEN=$(symp -k login $SYMP_USERNAME $SYMP_PASSWORD $SYMP_DOMAIN $SYMP_PROJECT -f value)
SYMP="symp -k --project-token=$TOKEN"

echo "Extracting own VM ID" | $TLOG
VM_INFO=$(curl http://169.254.169.254/openstack/latest/meta_data.json)
MYVM_ID=$(echo ${VM_INFO} | jq -r .uuid)
echo "Own VM ID is $VM_UUID" | $TLOG

## { "block_device_mapping": [ {"snapshot_id": uuid, asd: asd}, ...] }
echo "Getting IMAGE INFO" | $TLOG
IMAGE_INFO=$($SYMP machine-images get ${IMAGE_ID} -f json)
IMAGE_SNAPSHOTS=$(echo ${IMAGE_INFO} | jq -r .block_device_mapping[].snapshot_id)
for SN in ${IMAGE_SNAPSHOTS}
do
  # Saving current disk device names
  LVOLUMES=($(lsblk --output NAME -d -n -e 11 | sed -z 's/\n/\|/g'))
  echo "Currently attached devices $LVOLUMES" | $TLOG
  LVOLUMES=${LVOLUMES}dummyeoff

  echo "Cloning image snapshot: $SN" | $TLOG
  echo "running command: volume create --source-id $SN \"volume_for_image_download\"" | $TLOG
  VOLUME_INFO=$($SYMP volume create --source-id $SN -f json "volume_for_image_download_${IMAGE_ID}")
  VOLUME_ID=$(echo $VOLUME_INFO | jq -r .id)
  SNAPSHOT_INFO=$($SYMP snapshot get $SN -f json)
  SNAPSHOT_NAME=$(echo ${SNAPSHOT_INFO} | jq -r .name)
  echo "Attaching new volumes and waiting for them be seen by the OS" | $TLOG
  echo "running command: vm volumes attach $MYVM_ID $VOLUME_ID" | $TLOG
  $SYMP vm volumes attach $MYVM_ID $VOLUME_ID | $TLOG

  sleep 15 # allow kernel to recognize new voles.
  $SYMP vm get -c id -c name -c bootVolume -c volumes -c networks -c vpc_id -c instanceType $MYVM_ID 2>>$LOG || $TLOG
  echo "vm devices:" | $TLOG
  lsblk --output NAME -d -n -e 11 | $TLOG
  LOCALVOLS=(`lsblk --output NAME -d -n -e 11 | egrep -v "$LVOLUMES"`)
  for ADDED_VOL in ${LOCALVOLS[*]}
  do
	  echo "Detected added volume: $ADDED_VOL" | $TLOG
    qemu-img convert -f raw -O qcow2 /dev/$ADDED_VOL volume_$SNAPSHOT_NAME.qcow2
  done
done
```

5. Çalıştırılabilir hale getirilir:

   ```bash
   chmod +x export.sh
   ```

---

## 5. Image Oluşturma

1. Export edilecek VM kapatılır.
2. VM üzerinde sağ tıklanarak **Create Image** seçilir.
3. Oluşturulan image bulunur (Menu \> Images) ve **UUID** değeri not edilir.

---

## 6. QCOW2 Dönüşüm İşlemi

Aşağıdaki komut çalıştırılır:

```bash
./export <Image UUID>
```

Dönüşüm tamamlandığında `qcow2` formatında dosya elde edilir.

---

## 7. Object Storage Üzerine Yükleme

> **Not:** Upload işlemi tercihen farklı bir lokasyonda bulunan (export edilen VM Konya'da ise İstanbul'daki object storage gibi) object storage üzerinde yapılmalıdır. Aynı lokasyon seçilirse ek firewall kuralları (loopback tanımı gibi) gerekebilir.

1. Object storage'da pratik olması açısından kendi hesabınız üzerinde müşteri adına bir bucket açılır: `musteriadi`
2. Bucket seçilir ve **Permissions \> Make Public \> Save** işlemi uygulanır.

---

## 8. Dosyanın Yüklenmesi

1. AWS CLI yapılandırılır:

   ```bash
   aws configure
   ```

   Sırasıyla sizden aşağıda bilgileri isteyecektir:
   - Access Key
   - Secret Key
   - Region: `us-east-1`
   - Output format: json
2. Yükleme işlemi başlatılır:

   ```bash
   aws s3 --endpoint-url="https://object-<kullandiginiz object storage>.rng.tech" cp <QCOW2 Dosyası> s3://musteriadi/
   ```

---

## 9. Link Doğrulama ve Teslim

1. Upload tamamlandıktan sonra object storage panelinden ilgili dosya seçilir.
2. **Properties** bölümünde yer alan URL kopyalanır.
3. Dosya indirme testi yapılır.
4. İndirme başarılı ve 7zip ile açılıyorsa link müşteriye teslim edilir.

QCOW2 global bir dosya formatı olduğu için müşteri ister bu dosya ile VM oluşturulabilir veya içerisinden istediği bir dosyayı alabilir.

Aşağıdaki örnekte Windows'da QCOW2'den dosya alma adımları yer almaktadır.

## 10. Windows'da QCOW2 İçeriği Görüntüleme

**1. QEMU-IMG Kurulumu**

1. QEMU for Windows indirilip kurulmalıdır. (https://qemu.weilnetz.de/w64)
2. qemu-img.exe kurulum sonrası genelde C:\\Program Files\\qemu\\ altında bulunur.

**2. qcow2 → RAW Formatına Dönüştürme**

PowerShell’i **Yönetici** olarak açın ve şu komutu çalıştırın:

- cd "C:\\Program Files\\qemu"
- .\\qemu-img.exe convert -O raw "C:\\Users\\Administrator\\Downloads\\\<dosya_adi\>.qcow2" "C:\\Users\\Administrator\\Downloads\\\<dosya_adi\>.raw"
- 

Not: RAW çıktısı qcow2’nin sanal boyutu kadar yer kaplar.\
Bu nedenle hedef diskte yeterli boş alan bulunmalıdır.

**3. OSFMount ile RAW Dosyasını Açma**

1. OSFMount indirilip kurulmalıdır. (https://www.osforensics.com/downloads/osfmount.exe)
2. Program açıldıktan sonra:
   - **Mount new…** seçilir.
   - image.raw dosyası seçilir.
   - İmaj içindeki NTFS partition seçilip sürücü harfi atanır.
3. Windows Explorer’da ilgili sürücü harfi altında dosyalar görüntülenebilir.

## 11. Özet

Bu prosedür sayesinde müşteri sanal makineleri güvenli ve standart bir şekilde `qcow2` formatında export edilerek object storage üzerinden erişime açılır. Süreç, hem iç operasyonlar hem de müşteri teslimatı için profesyonel bir standart sağlamaktadır.